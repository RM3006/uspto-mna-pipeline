name: Deploy Snowflake Infrastructure

on:
  push:
    branches:
      - main
    paths:
      # Monitor changes within the snowflake infrastructure directory
      - 'infrastructure/snowflake/**'
      # Exclude bootstrap scripts to prevent accidental redeployment
      - '!infrastructure/snowflake/bootstrap/**' 
  workflow_dispatch:

jobs:
  deploy-snowflake-infra:
    # Use Ubuntu 22.04 to ensure compatibility with SnowSQL dependencies
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install SnowSQL
        run: |
          curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.9-linux_x86_64.bash
          SNOWSQL_DEST=~/bin SNOWSQL_LOGIN_SHELL=~/.profile bash snowsql-1.2.9-linux_x86_64.bash

      - name: Execute Infrastructure Scripts
        # Set environment variables for SnowSQL authentication
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT_2 }}
          SNOWSQL_USER: ${{ secrets.SNOWFLAKE_USER_2 }}
          SNOWSQL_PWD: ${{ secrets.SNOWFLAKE_PASSWORD_2 }}
          SNOWSQL_ROLE: ${{ secrets.SNOWFLAKE_ROLE_2 }}
        run: |
          echo "Scanning for SQL files..."
          
          # Dynamically locate SQL files to execute
          # Exclude the bootstrap directory from the search path
          # Sort files alphabetically to ensure correct execution sequence

          find infrastructure/snowflake -name "*.sql" -not -path "*/bootstrap/*" | sort | while read file; do
            echo "Deploying: $file"
            ~/bin/snowsql \
              -o exit_on_error=true \
              -o friendly=false \
              -q "SET developer_user = '$SNOWSQL_USER'; !source $file"
          done